name: Git Workflow Check

on:
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  check-workflow:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full Git history

      - name: Initialize scoring
        id: init
        run: |
          echo "" > /tmp/git_feedback.md
          echo "## ğŸŒ¿ Git Workflow Check Results" >> /tmp/git_feedback.md
          echo "" >> /tmp/git_feedback.md

      - name: Check PR is from feature branch
        id: feature_branch
        run: |
          echo "ğŸ” Checking PR branch name..."

          score=0
          max_score=2
          feedback="### ğŸŒ¿ Feature Branch (0/$max_score points)\n\n"

          branch_name="${{ github.head_ref }}"

          if [[ "$branch_name" =~ ^feature/ ]]; then
            echo "âœ… PR is from feature branch: $branch_name"
            feedback+="âœ… PR is from feature branch: **$branch_name** (+2 points)\n"
            score=2
          else
            echo "âŒ PR must be from a feature/* branch"
            echo "   Current branch: $branch_name"
            feedback+="âŒ PR is from branch: **$branch_name** (should be feature/*) (0 points)\n"
          fi

          feedback=$(echo -e "$feedback" | sed "s/(0\/$max_score points)/($score\/$max_score points)/")
          echo -e "$feedback" >> /tmp/git_feedback.md
          echo "" >> /tmp/git_feedback.md

          echo "score=$score" >> $GITHUB_OUTPUT
          echo "max_score=$max_score" >> $GITHUB_OUTPUT

          if [ $score -lt $max_score ]; then
            echo "ğŸ’¡ **Hint:** Create branch with: \`git checkout -b feature/your-feature-name\`" >> /tmp/git_feedback.md
            echo "" >> /tmp/git_feedback.md
          fi

      - name: Check for multiple feature branches (group work)
        id: multiple_branches
        run: |
          echo "ğŸ” Checking for multiple feature branches..."

          score=0
          max_score=3
          feedback="### ğŸŒ³ Multiple Feature Branches - Group Work (0/$max_score points)\n\n"

          # Get all feature branches (both local and remote)
          git fetch origin --prune > /dev/null 2>&1 || true
          feature_branches=$(git branch -a | grep -E '(remotes/origin/feature/|^\s*feature/)' | sed 's/.*origin\///' | sed 's/^\s*//' | sort -u | grep -v HEAD || echo "")
          branch_count=$(echo "$feature_branches" | grep -v "^$" | wc -l)

          echo "Found $branch_count feature branches"

          if [ $branch_count -ge 4 ]; then
            echo "âœ… Excellent! Found $branch_count feature branches"
            feedback+="âœ… **Excellent!** Found $branch_count feature branches (+3 points)\n\n"
            feedback+="Branches:\n"
            echo "$feature_branches" | while read branch; do
              [ -n "$branch" ] && feedback+="- \`$branch\`\n"
            done
            score=3
          elif [ $branch_count -eq 3 ]; then
            echo "âœ… Good! Found 3 feature branches"
            feedback+="âœ… **Good!** Found 3 feature branches (+3 points)\n\n"
            feedback+="Branches:\n"
            echo "$feature_branches" | while read branch; do
              [ -n "$branch" ] && feedback+="- \`$branch\`\n"
            done
            score=3
          elif [ $branch_count -eq 2 ]; then
            echo "âœ… Meets requirement! Found 2 feature branches"
            feedback+="âœ… **Meets requirement!** Found 2 feature branches (+2 points)\n\n"
            feedback+="Branches:\n"
            echo "$feature_branches" | while read branch; do
              [ -n "$branch" ] && feedback+="- \`$branch\`\n"
            done
            score=2
          elif [ $branch_count -eq 1 ]; then
            echo "âš ï¸ Only 1 feature branch found - need at least 2"
            feedback+="âš ï¸ Only 1 feature branch found (+0 points)\n"
            feedback+="**Requirement:** At least 2 feature branches for group work\n"
          else
            echo "âŒ No feature branches found"
            feedback+="âŒ No feature branches found (0 points)\n"
          fi

          feedback=$(echo -e "$feedback" | sed "s/(0\/$max_score points)/($score\/$max_score points)/")
          echo -e "$feedback" >> /tmp/git_feedback.md
          echo "" >> /tmp/git_feedback.md

          echo "score=$score" >> $GITHUB_OUTPUT
          echo "max_score=$max_score" >> $GITHUB_OUTPUT

          if [ $score -lt 2 ]; then
            echo "ğŸ’¡ **Hint:** Create at least 2 feature branches for different features (e.g., \`feature/database-setup\`, \`feature/upload-page\`)" >> /tmp/git_feedback.md
            echo "" >> /tmp/git_feedback.md
          fi

      - name: Check for multiple contributors (group work)
        id: multiple_authors
        run: |
          echo "ğŸ” Checking for multiple contributors..."

          score=0
          max_score=3
          feedback="### ğŸ‘¥ Multiple Contributors - Group Work (0/$max_score points)\n\n"

          # Get all unique authors from all branches
          authors=$(git log --all --format='%an <%ae>' | sort -u)
          author_count=$(echo "$authors" | grep -v "^$" | wc -l)

          echo "Found $author_count unique authors"

          if [ $author_count -ge 4 ]; then
            echo "âœ… Excellent! Found $author_count contributors"
            feedback+="âœ… **Excellent!** Found $author_count unique contributors (+3 points)\n\n"
            feedback+="Contributors:\n"
            echo "$authors" | while read author; do
              [ -n "$author" ] && feedback+="- $author\n"
            done
            score=3
          elif [ $author_count -eq 3 ]; then
            echo "âœ… Great! Found 3 contributors"
            feedback+="âœ… **Great!** Found 3 unique contributors (+3 points)\n\n"
            feedback+="Contributors:\n"
            echo "$authors" | while read author; do
              [ -n "$author" ] && feedback+="- $author\n"
            done
            score=3
          elif [ $author_count -eq 2 ]; then
            echo "âœ… Good! Found 2 contributors"
            feedback+="âœ… **Good!** Found 2 unique contributors (+2 points)\n\n"
            feedback+="Contributors:\n"
            echo "$authors" | while read author; do
              [ -n "$author" ] && feedback+="- $author\n"
            done
            score=2
          elif [ $author_count -eq 1 ]; then
            echo "âš ï¸ Only 1 contributor found - this is a group assignment"
            feedback+="âš ï¸ Only 1 contributor found (+0 points)\n"
            feedback+="**This is a group assignment** - ensure all team members contribute commits\n"
          else
            echo "âŒ No contributors found"
            feedback+="âŒ No contributors found (0 points)\n"
          fi

          feedback=$(echo -e "$feedback" | sed "s/(0\/$max_score points)/($score\/$max_score points)/")
          echo -e "$feedback" >> /tmp/git_feedback.md
          echo "" >> /tmp/git_feedback.md

          echo "score=$score" >> $GITHUB_OUTPUT
          echo "max_score=$max_score" >> $GITHUB_OUTPUT

          if [ $score -lt 2 ]; then
            echo "ğŸ’¡ **Hint:** Each team member should make commits. Configure git with: \`git config user.name\` and \`git config user.email\`" >> /tmp/git_feedback.md
            echo "" >> /tmp/git_feedback.md
          fi

      - name: Check multiple commits (incremental development)
        id: commits
        run: |
          echo "ğŸ” Checking commit history..."

          score=0
          max_score=3
          feedback="### ğŸ“ Commit History (0/$max_score points)\n\n"

          # Count commits in this PR
          commit_count=$(git rev-list --count HEAD ^origin/main)

          echo "Found $commit_count commits in this PR"
          feedback+="Found **$commit_count commits** in this PR\n\n"

          if [ "$commit_count" -ge 3 ]; then
            echo "âœ… Great! $commit_count commits shows excellent incremental work"
            feedback+="âœ… Excellent incremental development with $commit_count commits (+3 points)\n"
            score=3
          elif [ "$commit_count" -eq 2 ]; then
            echo "âœ… Good! 2 commits shows incremental work"
            feedback+="âœ… Good incremental development with 2 commits (+2 points)\n"
            score=2
          elif [ "$commit_count" -eq 1 ]; then
            echo "âš ï¸ Only 1 commit - consider breaking into smaller steps"
            feedback+="âš ï¸ Only 1 commit - consider breaking into incremental steps (+1 point)\n"
            score=1
          else
            echo "âŒ No commits found"
            feedback+="âŒ No commits found (0 points)\n"
          fi

          feedback=$(echo -e "$feedback" | sed "s/(0\/$max_score points)/($score\/$max_score points)/")
          echo -e "$feedback" >> /tmp/git_feedback.md
          echo "" >> /tmp/git_feedback.md

          echo "score=$score" >> $GITHUB_OUTPUT
          echo "max_score=$max_score" >> $GITHUB_OUTPUT

          if [ $score -lt 2 ]; then
            echo "ğŸ’¡ **Hint:** Break work into logical incremental commits (e.g., setup â†’ implementation â†’ tests)" >> /tmp/git_feedback.md
            echo "" >> /tmp/git_feedback.md
          fi

      - name: Check commit messages quality
        id: messages
        run: |
          echo "ğŸ” Checking commit message quality..."

          score=0
          max_score=3
          feedback="### âœï¸ Commit Message Quality (0/$max_score points)\n\n"

          # Get all commit messages in this PR
          git log --format=%s origin/main..HEAD > /tmp/commit_messages.txt

          short_messages=0
          descriptive_messages=0
          total_messages=0

          while IFS= read -r msg; do
            total_messages=$((total_messages + 1))
            msg_length=${#msg}

            if [ $msg_length -lt 10 ]; then
              echo "âŒ Too short: '$msg'"
              feedback+="âŒ Too short ($msg_length chars): \"$msg\"\n"
              short_messages=$((short_messages + 1))
            elif [ $msg_length -lt 20 ]; then
              echo "âš ï¸ Could be more descriptive: '$msg'"
              feedback+="âš ï¸ Could be more descriptive: \"$msg\"\n"
            else
              echo "âœ… Good message: '$msg'"
              feedback+="âœ… Good message: \"$msg\"\n"
              descriptive_messages=$((descriptive_messages + 1))
            fi
          done < /tmp/commit_messages.txt

          # Calculate score (max 3 points)
          if [ $total_messages -eq 0 ]; then
            score=0
          else
            # Each descriptive message is worth 1 point, max 3 points
            score=$descriptive_messages
            if [ $score -gt $max_score ]; then
              score=$max_score
            fi
          fi

          feedback=$(echo -e "$feedback" | sed "s/(0\/$max_score points)/($score\/$max_score points)/")
          echo -e "\n$feedback" >> /tmp/git_feedback.md
          echo "" >> /tmp/git_feedback.md

          echo "score=$score" >> $GITHUB_OUTPUT
          echo "max_score=$max_score" >> $GITHUB_OUTPUT

          if [ $score -lt $max_score ]; then
            echo "ğŸ’¡ **Hint:** Write descriptive commit messages (20+ characters) that explain WHAT and WHY" >> /tmp/git_feedback.md
            echo "- âœ… Good: \"Add database schema with SQLModel for road profiles\"" >> /tmp/git_feedback.md
            echo "- âŒ Bad: \"update\" or \"fix\"" >> /tmp/git_feedback.md
            echo "" >> /tmp/git_feedback.md
          fi

      - name: Calculate final score
        id: final
        if: always()
        run: |
          # Sum up all scores
          total_score=0
          total_max=0

          # Feature branch
          total_score=$((total_score + ${{ steps.feature_branch.outputs.score || 0 }}))
          total_max=$((total_max + ${{ steps.feature_branch.outputs.max_score || 0 }}))

          # Multiple branches (group work)
          total_score=$((total_score + ${{ steps.multiple_branches.outputs.score || 0 }}))
          total_max=$((total_max + ${{ steps.multiple_branches.outputs.max_score || 0 }}))

          # Multiple authors (group work)
          total_score=$((total_score + ${{ steps.multiple_authors.outputs.score || 0 }}))
          total_max=$((total_max + ${{ steps.multiple_authors.outputs.max_score || 0 }}))

          # Commits
          total_score=$((total_score + ${{ steps.commits.outputs.score || 0 }}))
          total_max=$((total_max + ${{ steps.commits.outputs.max_score || 0 }}))

          # Messages
          total_score=$((total_score + ${{ steps.messages.outputs.score || 0 }}))
          total_max=$((total_max + ${{ steps.messages.outputs.max_score || 0 }}))

          percentage=$((total_score * 100 / total_max))

          echo "---" >> /tmp/git_feedback.md
          echo "" >> /tmp/git_feedback.md
          echo "### ğŸ¯ Final Score: $total_score / $total_max points ($percentage%)" >> /tmp/git_feedback.md
          echo "" >> /tmp/git_feedback.md

          if [ $percentage -ge 90 ]; then
            grade="A"
            emoji="ğŸŒŸ"
            comment="Excellent Git workflow and group collaboration!"
          elif [ $percentage -ge 80 ]; then
            grade="B"
            emoji="ğŸ‘"
            comment="Good Git workflow and collaboration!"
          elif [ $percentage -ge 70 ]; then
            grade="C"
            emoji="ğŸ‘Œ"
            comment="Acceptable workflow, but room for improvement"
          elif [ $percentage -ge 60 ]; then
            grade="D"
            emoji="âš ï¸"
            comment="Git workflow needs improvement"
          else
            grade="F"
            emoji="âŒ"
            comment="Significant Git workflow and collaboration issues"
          fi

          echo "**Grade: $grade** $emoji" >> /tmp/git_feedback.md
          echo "" >> /tmp/git_feedback.md
          echo "*$comment*" >> /tmp/git_feedback.md
          echo "" >> /tmp/git_feedback.md
          echo "---" >> /tmp/git_feedback.md
          echo "" >> /tmp/git_feedback.md
          echo "*This automated check validates your Git workflow and group collaboration practices.*" >> /tmp/git_feedback.md

          echo "score=$total_score" >> $GITHUB_OUTPUT
          echo "max_score=$total_max" >> $GITHUB_OUTPUT
          echo "percentage=$percentage" >> $GITHUB_OUTPUT
          echo "grade=$grade" >> $GITHUB_OUTPUT

      - name: Post PR comment
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const feedback = fs.readFileSync('/tmp/git_feedback.md', 'utf8');

            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.data.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ğŸŒ¿ Git Workflow Check Results')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: feedback
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: feedback
              });
            }

      - name: Summary
        if: always()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ Git Workflow Check Complete!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Score: ${{ steps.final.outputs.score }} / ${{ steps.final.outputs.max_score }} (${{ steps.final.outputs.percentage }}%)"
          echo "Grade: ${{ steps.final.outputs.grade }}"
          echo ""
          cat /tmp/git_feedback.md
