name: Git Workflow Check

on:
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  check-workflow:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full Git history

      - name: Initialize scoring
        id: init
        run: |
          echo "" > /tmp/git_feedback.md
          echo "## ğŸŒ¿ Git Workflow Check Results" >> /tmp/git_feedback.md
          echo "" >> /tmp/git_feedback.md

      - name: Check PR is from feature branch
        id: feature_branch
        run: |
          echo "ğŸ” Checking PR branch name..."

          feedback="### ğŸŒ¿ Feature Branch\n\n"
          branch_name="${{ github.head_ref }}"

          if [[ "$branch_name" =~ ^feature/ ]]; then
            echo "âœ… PR is from feature branch: $branch_name"
            feedback+="âœ… **Status:** PASSED - PR is from feature branch: **$branch_name**\n"
            passed=true
          else
            echo "âŒ PR must be from a feature/* branch"
            echo "   Current branch: $branch_name"
            feedback+="âŒ **Status:** FAILED - PR is from branch: **$branch_name** (should be feature/*)\n"
            passed=false
          fi

          echo -e "$feedback" >> /tmp/git_feedback.md
          echo "" >> /tmp/git_feedback.md

          echo "passed=$passed" >> $GITHUB_OUTPUT

          if [ "$passed" != "true" ]; then
            echo "ğŸ’¡ **Fix:** Create branch with: \`git checkout -b feature/your-feature-name\`" >> /tmp/git_feedback.md
            echo "" >> /tmp/git_feedback.md
          fi

      - name: Check for multiple feature branches (group work)
        id: multiple_branches
        run: |
          echo "ğŸ” Checking for multiple feature branches..."

          feedback="### ğŸŒ³ Multiple Feature Branches - Group Work\n\n"

          # Get all feature branches (both local and remote)
          git fetch origin --prune > /dev/null 2>&1 || true
          feature_branches=$(git branch -a | grep -E '(remotes/origin/feature/|^\s*feature/)' | sed 's/.*origin\///' | sed 's/^\s*//' | sort -u | grep -v HEAD || echo "")
          branch_count=$(echo "$feature_branches" | grep -v "^$" | wc -l)

          echo "Found $branch_count feature branches"

          if [ $branch_count -ge 2 ]; then
            echo "âœ… Found $branch_count feature branches (requirement: â‰¥2)"
            feedback+="âœ… **Status:** PASSED - Found $branch_count feature branches (requirement: â‰¥2)\n\n"
            feedback+="Branches:\n"
            echo "$feature_branches" | while read branch; do
              [ -n "$branch" ] && feedback+="- \`$branch\`\n"
            done
            passed=true
          elif [ $branch_count -eq 1 ]; then
            echo "âŒ Only 1 feature branch found - need at least 2"
            feedback+="âŒ **Status:** FAILED - Only 1 feature branch found\n"
            feedback+="**Requirement:** At least 2 feature branches for group work\n"
            passed=false
          else
            echo "âŒ No feature branches found"
            feedback+="âŒ **Status:** FAILED - No feature branches found\n"
            passed=false
          fi

          echo -e "$feedback" >> /tmp/git_feedback.md
          echo "" >> /tmp/git_feedback.md

          echo "passed=$passed" >> $GITHUB_OUTPUT

          if [ "$passed" != "true" ]; then
            echo "ğŸ’¡ **Fix:** Create at least 2 feature branches for different features (e.g., \`feature/database-setup\`, \`feature/upload-page\`)" >> /tmp/git_feedback.md
            echo "" >> /tmp/git_feedback.md
          fi

      - name: Check for multiple contributors (group work)
        id: multiple_authors
        run: |
          echo "ğŸ” Checking for multiple contributors..."

          feedback="### ğŸ‘¥ Multiple Contributors - Group Work\n\n"

          # Get all unique authors from all branches
          authors=$(git log --all --format='%an <%ae>' | sort -u)
          author_count=$(echo "$authors" | grep -v "^$" | wc -l)

          echo "Found $author_count unique authors"

          if [ $author_count -ge 2 ]; then
            echo "âœ… Found $author_count contributors (requirement: â‰¥2)"
            feedback+="âœ… **Status:** PASSED - Found $author_count unique contributors (requirement: â‰¥2)\n\n"
            feedback+="Contributors:\n"
            echo "$authors" | while read author; do
              [ -n "$author" ] && feedback+="- $author\n"
            done
            passed=true
          elif [ $author_count -eq 1 ]; then
            echo "âŒ Only 1 contributor found - this is a group assignment"
            feedback+="âŒ **Status:** FAILED - Only 1 contributor found\n"
            feedback+="**This is a group assignment** - ensure all team members contribute commits\n"
            passed=false
          else
            echo "âŒ No contributors found"
            feedback+="âŒ **Status:** FAILED - No contributors found\n"
            passed=false
          fi

          echo -e "$feedback" >> /tmp/git_feedback.md
          echo "" >> /tmp/git_feedback.md

          echo "passed=$passed" >> $GITHUB_OUTPUT

          if [ "$passed" != "true" ]; then
            echo "ğŸ’¡ **Fix:** Each team member should make commits. Configure git with: \`git config user.name\` and \`git config user.email\`" >> /tmp/git_feedback.md
            echo "" >> /tmp/git_feedback.md
          fi

      - name: Check multiple commits (incremental development)
        id: commits
        run: |
          echo "ğŸ” Checking commit history..."

          feedback="### ğŸ“ Commit History\n\n"

          # Count commits in this PR
          commit_count=$(git rev-list --count HEAD ^origin/main)

          echo "Found $commit_count commits in this PR"
          feedback+="Found **$commit_count commits** in this PR\n\n"

          if [ "$commit_count" -ge 2 ]; then
            echo "âœ… $commit_count commits shows incremental development (requirement: â‰¥2)"
            feedback+="âœ… **Status:** PASSED - $commit_count commits shows incremental development (requirement: â‰¥2)\n"
            passed=true
          elif [ "$commit_count" -eq 1 ]; then
            echo "âŒ Only 1 commit - need at least 2 for incremental development"
            feedback+="âŒ **Status:** FAILED - Only 1 commit found\n"
            passed=false
          else
            echo "âŒ No commits found"
            feedback+="âŒ **Status:** FAILED - No commits found\n"
            passed=false
          fi

          echo -e "$feedback" >> /tmp/git_feedback.md
          echo "" >> /tmp/git_feedback.md

          echo "passed=$passed" >> $GITHUB_OUTPUT

          if [ "$passed" != "true" ]; then
            echo "ğŸ’¡ **Fix:** Break work into logical incremental commits (e.g., setup â†’ implementation â†’ tests)" >> /tmp/git_feedback.md
            echo "" >> /tmp/git_feedback.md
          fi

      - name: Check commit messages quality
        id: messages
        run: |
          echo "ğŸ” Checking commit message quality..."

          feedback="### âœï¸ Commit Message Quality\n\n"

          # Get all commit messages in this PR
          git log --format=%s origin/main..HEAD > /tmp/commit_messages.txt

          short_messages=0
          descriptive_messages=0
          total_messages=0

          while IFS= read -r msg; do
            total_messages=$((total_messages + 1))
            msg_length=${#msg}

            if [ $msg_length -lt 10 ]; then
              echo "âŒ Too short: '$msg'"
              feedback+="âŒ Too short ($msg_length chars): \"$msg\"\n"
              short_messages=$((short_messages + 1))
            elif [ $msg_length -lt 20 ]; then
              echo "âš ï¸ Could be more descriptive: '$msg'"
              feedback+="âš ï¸ Could be more descriptive: \"$msg\"\n"
            else
              echo "âœ… Good message: '$msg'"
              feedback+="âœ… Good message: \"$msg\"\n"
              descriptive_messages=$((descriptive_messages + 1))
            fi
          done < /tmp/commit_messages.txt

          # Pass if at least 50% of messages are descriptive (â‰¥20 chars)
          if [ $total_messages -eq 0 ]; then
            passed=false
          else
            threshold=$((total_messages / 2))
            if [ $descriptive_messages -ge $threshold ]; then
              passed=true
            else
              passed=false
            fi
          fi

          if [ "$passed" = "true" ]; then
            feedback+="\nâœ… **Status:** PASSED - $descriptive_messages/$total_messages messages are descriptive (â‰¥50% required)\n"
          else
            feedback+="\nâŒ **Status:** FAILED - $descriptive_messages/$total_messages messages are descriptive (â‰¥50% required)\n"
          fi

          echo -e "$feedback" >> /tmp/git_feedback.md
          echo "" >> /tmp/git_feedback.md

          echo "passed=$passed" >> $GITHUB_OUTPUT

          if [ "$passed" != "true" ]; then
            echo "ğŸ’¡ **Fix:** Write descriptive commit messages (20+ characters) that explain WHAT and WHY" >> /tmp/git_feedback.md
            echo "- âœ… Good: \"Add database schema with SQLModel for road profiles\"" >> /tmp/git_feedback.md
            echo "- âŒ Bad: \"update\" or \"fix\"" >> /tmp/git_feedback.md
            echo "" >> /tmp/git_feedback.md
          fi

      - name: Calculate summary
        id: summary
        if: always()
        run: |
          # Count how many checks passed
          checks_passed=0
          checks_total=5

          feature_branch_passed="${{ steps.feature_branch.outputs.passed }}"
          multiple_branches_passed="${{ steps.multiple_branches.outputs.passed }}"
          multiple_authors_passed="${{ steps.multiple_authors.outputs.passed }}"
          commits_passed="${{ steps.commits.outputs.passed }}"
          messages_passed="${{ steps.messages.outputs.passed }}"

          [ "$feature_branch_passed" = "true" ] && checks_passed=$((checks_passed + 1))
          [ "$multiple_branches_passed" = "true" ] && checks_passed=$((checks_passed + 1))
          [ "$multiple_authors_passed" = "true" ] && checks_passed=$((checks_passed + 1))
          [ "$commits_passed" = "true" ] && checks_passed=$((checks_passed + 1))
          [ "$messages_passed" = "true" ] && checks_passed=$((checks_passed + 1))

          percentage=$((checks_passed * 100 / checks_total))

          echo "---" >> /tmp/git_feedback.md
          echo "" >> /tmp/git_feedback.md
          echo "### ğŸ¯ Summary: $checks_passed / $checks_total checks passed ($percentage%)" >> /tmp/git_feedback.md
          echo "" >> /tmp/git_feedback.md

          if [ $percentage -eq 100 ]; then
            echo "âœ… **All Git workflow checks passed!** âœ…" >> /tmp/git_feedback.md
            all_passed=true
          else
            echo "âš ï¸ **Some Git workflow checks failed.** Please fix the issues above." >> /tmp/git_feedback.md
            all_passed=false
          fi

          echo "" >> /tmp/git_feedback.md
          echo "---" >> /tmp/git_feedback.md
          echo "" >> /tmp/git_feedback.md
          echo "*This automated check validates your Git workflow and group collaboration practices.*" >> /tmp/git_feedback.md

          echo "checks_passed=$checks_passed" >> $GITHUB_OUTPUT
          echo "checks_total=$checks_total" >> $GITHUB_OUTPUT
          echo "percentage=$percentage" >> $GITHUB_OUTPUT
          echo "all_passed=$all_passed" >> $GITHUB_OUTPUT

      - name: Post PR comment
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const feedback = fs.readFileSync('/tmp/git_feedback.md', 'utf8');

            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.data.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ğŸŒ¿ Git Workflow Check Results')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: feedback
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: feedback
              });
            }

      - name: Summary
        if: always()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ Git Workflow Check Complete!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Checks: ${{ steps.summary.outputs.checks_passed }} / ${{ steps.summary.outputs.checks_total }} passed (${{ steps.summary.outputs.percentage }}%)"
          echo ""
          cat /tmp/git_feedback.md
