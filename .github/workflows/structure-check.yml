name: Structure Check

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  check-structure:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize scoring
        id: init
        run: |
          echo "score=0" >> $GITHUB_OUTPUT
          echo "max_score=0" >> $GITHUB_OUTPUT
          echo "" > /tmp/feedback.md
          echo "## ğŸ“Š Structure Check Results" >> /tmp/feedback.md
          echo "" >> /tmp/feedback.md

      - name: Check required documentation files
        id: docs
        run: |
          echo "ğŸ” Checking required documentation..."

          score=0
          max_score=3
          feedback="### ğŸ“ Documentation (0/$max_score points)\n\n"

          if [ -f docs/implementation-plan.md ]; then
            echo "âœ… docs/implementation-plan.md exists"
            feedback+="âœ… **Implementation plan** exists (+2 points)\n"
            score=$((score + 2))
          else
            echo "âŒ docs/implementation-plan.md not found"
            feedback+="âŒ **Implementation plan** missing (0 points)\n"
          fi

          if [ -f docs/example-road-profile.json ]; then
            echo "âœ… docs/example-road-profile.json exists"
            feedback+="âœ… **Example JSON** exists (+1 point)\n"
            score=$((score + 1))
          else
            echo "âŒ docs/example-road-profile.json not found"
            feedback+="âŒ **Example JSON** missing (0 points)\n"
          fi

          feedback=$(echo -e "$feedback" | sed "s/(0\/$max_score points)/($score\/$max_score points)/")
          echo -e "$feedback" >> /tmp/feedback.md
          echo "" >> /tmp/feedback.md

          echo "score=$score" >> $GITHUB_OUTPUT
          echo "max_score=$max_score" >> $GITHUB_OUTPUT

          if [ $score -lt $max_score ]; then
            echo "ğŸ’¡ **Hint:** Create implementation plan in docs/ folder" >> /tmp/feedback.md
            echo "" >> /tmp/feedback.md
          fi

      - name: Check Pydantic models
        id: models
        if: always()
        run: |
          echo "ğŸ” Checking Pydantic validation models..."

          score=0
          max_score=2
          feedback="### ğŸ”¬ Pydantic Models (0/$max_score points)\n\n"

          if [ -f src/road_profile_viewer/models.py ]; then
            echo "âœ… models.py exists"
            feedback+="âœ… **models.py** exists (+1 point)\n"
            score=$((score + 1))

            # Check for RoadProfile model
            if grep -q "class RoadProfile" src/road_profile_viewer/models.py; then
              echo "âœ… RoadProfile model found"
              feedback+="âœ… **RoadProfile** model defined (+1 point)\n"
              score=$((score + 1))
            else
              echo "âŒ RoadProfile model not found"
              feedback+="âŒ **RoadProfile** model missing (0 points)\n"
            fi
          else
            echo "âŒ models.py not found"
            feedback+="âŒ **models.py** missing (0 points)\n"
          fi

          feedback=$(echo -e "$feedback" | sed "s/(0\/$max_score points)/($score\/$max_score points)/")
          echo -e "$feedback" >> /tmp/feedback.md
          echo "" >> /tmp/feedback.md

          echo "score=$score" >> $GITHUB_OUTPUT
          echo "max_score=$max_score" >> $GITHUB_OUTPUT

          if [ $score -lt $max_score ]; then
            echo "ğŸ’¡ **Hint:** Create src/road_profile_viewer/models.py with Pydantic models" >> /tmp/feedback.md
            echo "" >> /tmp/feedback.md
          fi

      - name: Check database module
        id: database
        if: always()
        run: |
          echo "ğŸ” Checking database module..."

          score=0
          max_score=2
          feedback="### ğŸ’¾ Database Module (0/$max_score points)\n\n"

          # Check if database folder exists
          if [ -d src/road_profile_viewer/database ]; then
            echo "âœ… database/ folder exists"
            feedback+="âœ… **database/** folder exists (+1 point)\n"
            score=$((score + 1))

            # Check for either SQLModel models or TinyDB implementation
            if [ -f src/road_profile_viewer/database/models.py ] || [ -f src/road_profile_viewer/database/db.py ]; then
              echo "âœ… Database implementation found"
              feedback+="âœ… **Database implementation** found (+1 point)\n"
              score=$((score + 1))
            else
              echo "âŒ No database implementation found"
              feedback+="âŒ **Database implementation** missing (0 points)\n"
            fi
          else
            echo "âŒ database/ folder not found"
            feedback+="âŒ **database/** folder missing (0 points)\n"
          fi

          feedback=$(echo -e "$feedback" | sed "s/(0\/$max_score points)/($score\/$max_score points)/")
          echo -e "$feedback" >> /tmp/feedback.md
          echo "" >> /tmp/feedback.md

          echo "score=$score" >> $GITHUB_OUTPUT
          echo "max_score=$max_score" >> $GITHUB_OUTPUT

          if [ $score -lt $max_score ]; then
            echo "ğŸ’¡ **Hint:** Create src/road_profile_viewer/database/ with your chosen approach (FastAPI or TinyDB)" >> /tmp/feedback.md
            echo "" >> /tmp/feedback.md
          fi

      - name: Check for API module (FastAPI bonus)
        id: api
        if: always()
        continue-on-error: true
        run: |
          echo "ğŸ” Checking for FastAPI implementation (bonus)..."

          score=0
          max_score=2
          feedback="### ğŸš€ FastAPI Implementation - BONUS (0/$max_score points)\n\n"

          if [ -d src/road_profile_viewer/api ]; then
            echo "âœ… api/ folder exists"
            feedback+="âœ… **api/** folder exists (+1 point)\n"
            score=$((score + 1))

            if [ -f src/road_profile_viewer/api/main.py ]; then
              echo "âœ… api/main.py found"
              feedback+="âœ… **FastAPI app** found (+1 point bonus!)\n"
              score=$((score + 1))
            fi
          else
            echo "â„¹ï¸ No API folder (using TinyDB approach)"
            feedback+="â„¹ï¸ **No API folder** - Using TinyDB approach\n"
          fi

          feedback=$(echo -e "$feedback" | sed "s/(0\/$max_score points)/($score\/$max_score points)/")
          echo -e "$feedback" >> /tmp/feedback.md
          echo "" >> /tmp/feedback.md

          echo "score=$score" >> $GITHUB_OUTPUT
          echo "max_score=$max_score" >> $GITHUB_OUTPUT

      - name: Check .gitignore includes database file
        id: gitignore
        if: always()
        run: |
          echo "ğŸ” Checking .gitignore..."

          score=0
          max_score=1
          feedback="### ğŸš« .gitignore (0/$max_score points)\n\n"

          if [ -f .gitignore ]; then
            # Check for common database file patterns
            if grep -qE "\.db$|\.sqlite|profiles\.json|database/.*\.json" .gitignore; then
              echo "âœ… Database files in .gitignore"
              feedback+="âœ… **Database files** excluded from git (+1 point)\n"
              score=$((score + 1))
            else
              echo "âš ï¸ Database files might not be ignored"
              feedback+="âš ï¸ **Consider adding** database files to .gitignore\n"
            fi
          fi

          feedback=$(echo -e "$feedback" | sed "s/(0\/$max_score points)/($score\/$max_score points)/")
          echo -e "$feedback" >> /tmp/feedback.md
          echo "" >> /tmp/feedback.md

          echo "score=$score" >> $GITHUB_OUTPUT
          echo "max_score=$max_score" >> $GITHUB_OUTPUT

          if [ $score -lt $max_score ]; then
            echo "ğŸ’¡ **Hint:** Add \`*.db\`, \`*.sqlite\`, and data files to .gitignore" >> /tmp/feedback.md
            echo "" >> /tmp/feedback.md
          fi

      - name: Calculate final score
        id: final
        if: always()
        run: |
          # Sum up all scores (excluding API bonus)
          total_score=0
          total_max=0

          # Documentation
          total_score=$((total_score + ${{ steps.docs.outputs.score || 0 }}))
          total_max=$((total_max + ${{ steps.docs.outputs.max_score || 0 }}))

          # Models
          total_score=$((total_score + ${{ steps.models.outputs.score || 0 }}))
          total_max=$((total_max + ${{ steps.models.outputs.max_score || 0 }}))

          # Database
          total_score=$((total_score + ${{ steps.database.outputs.score || 0 }}))
          total_max=$((total_max + ${{ steps.database.outputs.max_score || 0 }}))

          # Gitignore
          total_score=$((total_score + ${{ steps.gitignore.outputs.score || 0 }}))
          total_max=$((total_max + ${{ steps.gitignore.outputs.max_score || 0 }}))

          # API bonus (doesn't count against you if missing)
          api_bonus=${{ steps.api.outputs.score || 0 }}

          percentage=$((total_score * 100 / total_max))

          echo "---" >> /tmp/feedback.md
          echo "" >> /tmp/feedback.md
          echo "### ğŸ¯ Base Score: $total_score / $total_max points ($percentage%)" >> /tmp/feedback.md

          if [ $api_bonus -gt 0 ]; then
            echo "### ğŸŒŸ Bonus: +$api_bonus points for FastAPI implementation!" >> /tmp/feedback.md
          fi

          echo "" >> /tmp/feedback.md

          if [ $percentage -ge 80 ]; then
            grade="A"
            emoji="ğŸŒŸ"
            comment="Excellent structure!"
            all_passed=true
          elif [ $percentage -ge 70 ]; then
            grade="B"
            emoji="ğŸ‘"
            comment="Good structure with minor gaps"
            all_passed=false
          elif [ $percentage -ge 60 ]; then
            grade="C"
            emoji="ğŸ‘Œ"
            comment="Acceptable, but needs improvement"
            all_passed=false
          else
            grade="F"
            emoji="âŒ"
            comment="Critical structure issues"
            all_passed=false
          fi

          echo "**Grade: $grade** $emoji" >> /tmp/feedback.md
          echo "" >> /tmp/feedback.md
          echo "*$comment*" >> /tmp/feedback.md
          echo "" >> /tmp/feedback.md

          if [ $all_passed = true ]; then
            echo "---" >> /tmp/feedback.md
            echo "" >> /tmp/feedback.md
            echo "âœ… **Structure check passed!**" >> /tmp/feedback.md
          else
            echo "---" >> /tmp/feedback.md
            echo "" >> /tmp/feedback.md
            echo "âš ï¸ **Structure check has issues.** Please address them before merging." >> /tmp/feedback.md
          fi

          echo "" >> /tmp/feedback.md
          echo "---" >> /tmp/feedback.md
          echo "" >> /tmp/feedback.md
          echo "*This check validates your project structure matches the assignment requirements.*" >> /tmp/feedback.md

          echo "score=$total_score" >> $GITHUB_OUTPUT
          echo "max_score=$total_max" >> $GITHUB_OUTPUT
          echo "percentage=$percentage" >> $GITHUB_OUTPUT
          echo "grade=$grade" >> $GITHUB_OUTPUT
          echo "all_passed=$all_passed" >> $GITHUB_OUTPUT

      - name: Post PR comment
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const feedback = fs.readFileSync('/tmp/feedback.md', 'utf8');

            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.data.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ğŸ“Š Structure Check Results')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: feedback
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: feedback
              });
            }

      - name: Summary
        if: always()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ Structure Check Complete!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Score: ${{ steps.final.outputs.score }} / ${{ steps.final.outputs.max_score }} (${{ steps.final.outputs.percentage }}%)"
          echo "Grade: ${{ steps.final.outputs.grade }}"
          echo ""
          cat /tmp/feedback.md

      - name: Warn if structure incomplete
        if: steps.final.outputs.all_passed != 'true'
        run: |
          echo ""
          echo "âš ï¸ Structure check found issues!"
          echo "   Review the feedback above and complete the required files."
          # Don't fail - this is advisory only
          exit 0
