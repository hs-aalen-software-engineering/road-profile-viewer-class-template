name: Structure Check

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  check-structure:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize scoring
        id: init
        run: |
          echo "score=0" >> $GITHUB_OUTPUT
          echo "max_score=0" >> $GITHUB_OUTPUT
          echo "" > /tmp/feedback.md
          echo "## ğŸ“Š Structure Check Results" >> /tmp/feedback.md
          echo "" >> /tmp/feedback.md

      - name: Check required documentation files
        id: docs
        run: |
          echo "ğŸ” Checking required documentation..."

          feedback="### ğŸ“ Documentation\n\n"
          docs_passed=0
          docs_total=2

          if [ -f docs/implementation-plan.md ]; then
            echo "âœ… docs/implementation-plan.md exists"
            feedback+="âœ… **Implementation plan** exists\n"
            docs_passed=$((docs_passed + 1))
          else
            echo "âŒ docs/implementation-plan.md not found"
            feedback+="âŒ **Implementation plan** missing\n"
          fi

          if [ -f docs/example-road-profile.json ]; then
            echo "âœ… docs/example-road-profile.json exists"
            feedback+="âœ… **Example JSON** exists\n"
            docs_passed=$((docs_passed + 1))
          else
            echo "âŒ docs/example-road-profile.json not found"
            feedback+="âŒ **Example JSON** missing\n"
          fi

          if [ $docs_passed -eq $docs_total ]; then
            feedback+="\nâœ… **Status:** PASSED - All documentation files present\n"
            passed=true
          else
            feedback+="\nâŒ **Status:** FAILED - Missing $((docs_total - docs_passed)) file(s)\n"
            passed=false
          fi

          echo -e "$feedback" >> /tmp/feedback.md
          echo "" >> /tmp/feedback.md

          echo "passed=$passed" >> $GITHUB_OUTPUT

          if [ "$passed" != "true" ]; then
            echo "ğŸ’¡ **Fix:** Create implementation plan in docs/ folder" >> /tmp/feedback.md
            echo "" >> /tmp/feedback.md
          fi

      - name: Check Pydantic models
        id: models
        if: always()
        run: |
          echo "ğŸ” Checking Pydantic validation models..."

          feedback="### ğŸ”¬ Pydantic Models\n\n"

          if [ -f src/road_profile_viewer/models.py ]; then
            echo "âœ… models.py exists"
            feedback+="âœ… **models.py** exists\n"

            # Check for RoadProfile model
            if grep -q "class RoadProfile" src/road_profile_viewer/models.py; then
              echo "âœ… RoadProfile model found"
              feedback+="âœ… **RoadProfile** model defined\n"
              feedback+="\nâœ… **Status:** PASSED - Pydantic models present\n"
              passed=true
            else
              echo "âŒ RoadProfile model not found"
              feedback+="âŒ **RoadProfile** model missing\n"
              feedback+="\nâŒ **Status:** FAILED - RoadProfile model not defined\n"
              passed=false
            fi
          else
            echo "âŒ models.py not found"
            feedback+="âŒ **models.py** missing\n"
            feedback+="\nâŒ **Status:** FAILED - models.py file not found\n"
            passed=false
          fi

          echo -e "$feedback" >> /tmp/feedback.md
          echo "" >> /tmp/feedback.md

          echo "passed=$passed" >> $GITHUB_OUTPUT

          if [ "$passed" != "true" ]; then
            echo "ğŸ’¡ **Fix:** Create src/road_profile_viewer/models.py with Pydantic models" >> /tmp/feedback.md
            echo "" >> /tmp/feedback.md
          fi

      - name: Check database module
        id: database
        if: always()
        run: |
          echo "ğŸ” Checking database module..."

          feedback="### ğŸ’¾ Database Module\n\n"

          # Check if database folder exists
          if [ -d src/road_profile_viewer/database ]; then
            echo "âœ… database/ folder exists"
            feedback+="âœ… **database/** folder exists\n"

            # Check for either SQLModel models or TinyDB implementation
            if [ -f src/road_profile_viewer/database/models.py ] || [ -f src/road_profile_viewer/database/db.py ]; then
              echo "âœ… Database implementation found"
              feedback+="âœ… **Database implementation** found\n"
              feedback+="\nâœ… **Status:** PASSED - Database module present\n"
              passed=true
            else
              echo "âŒ No database implementation found"
              feedback+="âŒ **Database implementation** missing\n"
              feedback+="\nâŒ **Status:** FAILED - No database implementation files\n"
              passed=false
            fi
          else
            echo "âŒ database/ folder not found"
            feedback+="âŒ **database/** folder missing\n"
            feedback+="\nâŒ **Status:** FAILED - database/ folder not found\n"
            passed=false
          fi

          echo -e "$feedback" >> /tmp/feedback.md
          echo "" >> /tmp/feedback.md

          echo "passed=$passed" >> $GITHUB_OUTPUT

          if [ "$passed" != "true" ]; then
            echo "ğŸ’¡ **Fix:** Create src/road_profile_viewer/database/ with your chosen approach (FastAPI or TinyDB)" >> /tmp/feedback.md
            echo "" >> /tmp/feedback.md
          fi

      - name: Check for API module (FastAPI bonus)
        id: api
        if: always()
        continue-on-error: true
        run: |
          echo "ğŸ” Checking for FastAPI implementation (bonus)..."

          feedback="### ğŸš€ FastAPI Implementation - BONUS\n\n"

          if [ -d src/road_profile_viewer/api ]; then
            echo "âœ… api/ folder exists"
            feedback+="âœ… **api/** folder exists\n"

            if [ -f src/road_profile_viewer/api/main.py ]; then
              echo "âœ… api/main.py found"
              feedback+="âœ… **FastAPI app** found - Bonus approach detected!\n"
              api_present=true
            else
              feedback+="â„¹ï¸ **api/main.py** not found yet\n"
              api_present=false
            fi
          else
            echo "â„¹ï¸ No API folder (using TinyDB approach)"
            feedback+="â„¹ï¸ **No API folder** - Using TinyDB approach\n"
            api_present=false
          fi

          echo -e "$feedback" >> /tmp/feedback.md
          echo "" >> /tmp/feedback.md

          echo "api_present=$api_present" >> $GITHUB_OUTPUT

      - name: Check .gitignore includes database file
        id: gitignore
        if: always()
        run: |
          echo "ğŸ” Checking .gitignore..."

          feedback="### ğŸš« .gitignore\n\n"

          if [ -f .gitignore ]; then
            # Check for common database file patterns
            if grep -qE "\.db$|\.sqlite|profiles\.json|database/.*\.json" .gitignore; then
              echo "âœ… Database files in .gitignore"
              feedback+="âœ… **Database files** excluded from git\n"
              feedback+="\nâœ… **Status:** PASSED - Database files properly ignored\n"
              passed=true
            else
              echo "âš ï¸ Database files might not be ignored"
              feedback+="âš ï¸ **Database files** might not be ignored\n"
              feedback+="\nâŒ **Status:** FAILED - Missing database file patterns in .gitignore\n"
              passed=false
            fi
          else
            feedback+="âŒ **.gitignore** not found\n"
            feedback+="\nâŒ **Status:** FAILED - .gitignore file missing\n"
            passed=false
          fi

          echo -e "$feedback" >> /tmp/feedback.md
          echo "" >> /tmp/feedback.md

          echo "passed=$passed" >> $GITHUB_OUTPUT

          if [ "$passed" != "true" ]; then
            echo "ğŸ’¡ **Fix:** Add \`*.db\`, \`*.sqlite\`, and data files to .gitignore" >> /tmp/feedback.md
            echo "" >> /tmp/feedback.md
          fi

      - name: Calculate summary
        id: summary
        if: always()
        run: |
          # Count how many checks passed
          checks_passed=0
          checks_total=4

          docs_passed="${{ steps.docs.outputs.passed }}"
          models_passed="${{ steps.models.outputs.passed }}"
          database_passed="${{ steps.database.outputs.passed }}"
          gitignore_passed="${{ steps.gitignore.outputs.passed }}"

          [ "$docs_passed" = "true" ] && checks_passed=$((checks_passed + 1))
          [ "$models_passed" = "true" ] && checks_passed=$((checks_passed + 1))
          [ "$database_passed" = "true" ] && checks_passed=$((checks_passed + 1))
          [ "$gitignore_passed" = "true" ] && checks_passed=$((checks_passed + 1))

          percentage=$((checks_passed * 100 / checks_total))

          echo "---" >> /tmp/feedback.md
          echo "" >> /tmp/feedback.md
          echo "### ğŸ¯ Summary: $checks_passed / $checks_total checks passed ($percentage%)" >> /tmp/feedback.md
          echo "" >> /tmp/feedback.md

          # Check for FastAPI bonus
          api_present="${{ steps.api.outputs.api_present }}"
          if [ "$api_present" = "true" ]; then
            echo "ğŸŒŸ **Bonus:** FastAPI implementation detected!" >> /tmp/feedback.md
            echo "" >> /tmp/feedback.md
          fi

          if [ $percentage -eq 100 ]; then
            echo "âœ… **All structure checks passed!** âœ…" >> /tmp/feedback.md
            all_passed=true
          else
            echo "âš ï¸ **Some structure checks failed.** Please address them before merging." >> /tmp/feedback.md
            all_passed=false
          fi

          echo "" >> /tmp/feedback.md
          echo "---" >> /tmp/feedback.md
          echo "" >> /tmp/feedback.md
          echo "*This check validates your project structure matches the assignment requirements.*" >> /tmp/feedback.md

          echo "checks_passed=$checks_passed" >> $GITHUB_OUTPUT
          echo "checks_total=$checks_total" >> $GITHUB_OUTPUT
          echo "percentage=$percentage" >> $GITHUB_OUTPUT
          echo "all_passed=$all_passed" >> $GITHUB_OUTPUT

      - name: Post PR comment
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const feedback = fs.readFileSync('/tmp/feedback.md', 'utf8');

            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.data.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ğŸ“Š Structure Check Results')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: feedback
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: feedback
              });
            }

      - name: Summary
        if: always()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ Structure Check Complete!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Checks: ${{ steps.summary.outputs.checks_passed }} / ${{ steps.summary.outputs.checks_total }} passed (${{ steps.summary.outputs.percentage }}%)"
          echo ""
          cat /tmp/feedback.md

      - name: Warn if structure incomplete
        if: steps.summary.outputs.all_passed != 'true'
        run: |
          echo ""
          echo "âš ï¸ Structure check found issues!"
          echo "   Review the feedback above and complete the required files."
          # Don't fail - this is advisory only
          exit 0
